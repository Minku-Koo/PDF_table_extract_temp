<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta content="text/html; charset=UTF-8" http-equiv="Content-Type" />
        <title>PDF Table Select Areas</title>
        <link rel="stylesheet" type="text/css" href="{{url_for('static', filename='css/extract.css')}}">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">

		<!--[if lte IE 8]><link href="../resources/jquery.selectareas.ie8.css" media="screen" rel="stylesheet" type="text/css" /> <![endif]-->
        <script type="text/javascript" src = "{{url_for('static',filename='js/jquery-1.11.3.min.js')}}"></script>

        
        <!-- JQUERY Select Areas plug-in -->
        <script type="text/javascript" src = "{{url_for('static',filename='js/jquery.selectareas.js')}}"></script>
        <link rel="stylesheet" type="text/css" href="{{url_for('static', filename='resources/jquery.selectareas.css')}}">
        <!--  -->

        <!-- JQUERY Tool tips plug-in -->
        <link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
        <script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
        <!--  -->

        
	<!-- <link rel="icon" href="{{ url_for('static', filename='css/image/icon.png') }}"> -->
        
        
		<script type="text/javascript">
            var this_page = 1;
            var detected_areas = JSON.parse( '{{detected_areas | tojson | safe}}' );

            $( document ).tooltip();
            
                

            // ÌÖåÏù¥Î∏î ÏÑ†ÌÉù ÏòÅÏó≠ ÌëúÏãú Ìï®Ïàò
            function set_select_areas(bboxs){
                if(bboxs != 0){
                    bboxs = bboxs.split(";");
                    
                    $("#pageImg").selectAreas('reset');
                    
                    arrs = [];
                    for(i=0 ; i<bboxs.length ; i++){
                        var arr = bboxs[i].split(',');

                        fileDimsX = Number(arr[4])
                        fileDimsY = Number(arr[5])
                        const imageWidth = $("img#pageImg").width();
                        const imageHeight = $("img#pageImg").height();

                        scalingFactorX = fileDimsX / imageWidth;
                        scalingFactorY = fileDimsY / imageHeight;

                        arrs.push({
                            x: Number(arr[0] / scalingFactorX),
                            y: Number(arr[1]/ scalingFactorY),
                            width: Number(arr[2]/ scalingFactorX),
                            height: Number(arr[3]/ scalingFactorY),
                        });
                    }
                    
                    $("#pageImg").selectAreas('add', arrs);
                }
            }


            // ÌéòÏù¥ÏßÄ Ïù¥Îèô Ìï®Ïàò (pre_pageÎäî ÌòÑÏû¨ ÌéòÏù¥ÏßÄ, pageÎäî Ïù¥ÎèôÌï† ÌéòÏù¥ÏßÄ)
            function move_page(pre_page, page){
                this_page = page;

                // Ïä§ÌÅ¨Î°§Î∞îÎ•º ÌòÑÏû¨ ÏÑ†ÌÉùÎêú Ïç∏ÎÑ§ÏùºÎ°ú Ïù¥ÎèôÏãúÌÇ§Í≥† Ï§ëÍ∞ÑÏóê ÏúÑÏπòÌïòÍ≤åÌï®
                document.getElementById('thumb_page_'+page).scrollIntoView({
                    behavior: 'auto',
                    block: 'center',
                    inline: 'center'
                });

                // thumb_img_select ÌÅ¥ÎûòÏä§Í∞Ä Ï†ÅÏö©Îêú Ïç∏ÎÑ§ÏùºÏùÄ Îπ®Í∞Ñ ÌÖåÎëêÎ¶¨Í∞Ä ÌëúÏãúÎê® (ÌòÑÏû¨ ÏÑ†ÌÉùÎêú ÌéòÏù¥ÏßÄÎùºÎäî Îúª)
                $('#thumb_page_'+pre_page).removeClass('thumb_img_select');
                $('#thumb_page_'+page).addClass('thumb_img_select');

                $('img#pageImg').attr('src', "{{url_for('static', filename='job_pdf')}}/{{fileName}}/page-"+page+".png");
                
                    
                if( detected_areas.hasOwnProperty(String(page)) ){
                    $("#pageImg").selectAreas('reset');
                    page = String(this_page);
                    set_select_areas( detected_areas[page] );
                }
            }

			$(document).ready(function () {

                // Ï∂îÏ∂úÌï† Î©îÏù∏ Ïù¥ÎØ∏ÏßÄ ÍµêÏ≤¥
                $('img#pageImg').attr("src", "{{url_for('static', filename='job_pdf')}}/{{fileName}}/page-"+this_page+".png");

                $('.arrow').click(function () {
					direction = $(this).text();
                    pre_page = this_page;

                    if (direction == "‚óÄ"){
                        this_page = Number(this_page)-1;
                        if(this_page < 1){
                            this_page = 1;
                        }
                    }
                    else{
                        this_page = Number(this_page)+1;
                    }
                    move_page(pre_page, this_page);
				});
            
                $('#get_line_size').click(function () {
					var selectedAreas = $('img#pageImg').selectAreas('areas');
                    
                    if (selectedAreas.length > 0) {
                        const imageWidth = $('#pageImg').width();
                        const imageHeight = $('#pageImg').height();
                    
                        var table_option = $("input[name='optradio']:checked").val();
                        var jsons = {};
                        
                        for(i=0 ; i<selectedAreas.length ; i++){
                            selectedAreas[i]['imageWidth'] = imageWidth;
                            selectedAreas[i]['imageHeight'] = imageHeight;
                            jsons[i] = JSON.stringify(selectedAreas[i]);
                        }
                        jsons = JSON.stringify(jsons);

                        $.ajax({
                            url: '/getLineScale',
                            data: {"jsons":jsons, "fileName":"{{fileName}}", "page":this_page},
                            dataType:'json',
                            type: 'POST',
                            success: function (data) {
                                $("#line_scale").val(data.line_scale);
                            },
                            error: function (error) {
                                console.error(error);
                            }
                        });
                    }
                    else{
                        alert("Î®ºÏ†Ä ÏòÅÏó≠ÏùÑ ÏßÄÏ†ïÌï¥Ï£ºÏÑ∏Ïöî.");
                    }
				});
                
                $('#extract').click(function () {
					var selectedAreas = $('img#pageImg').selectAreas('areas');

                    console.log(selectedAreas);
                    
                    if (selectedAreas.length > 0) {
                        const imageWidth = $('#pageImg').width();
                        const imageHeight = $('#pageImg').height();
                    
                        var table_option = $("input[name='optradio']:checked").val();
                        var jsons = {};
                        
                        for(i=0 ; i<selectedAreas.length ; i++){
                            selectedAreas[i]['imageWidth'] = imageWidth;
                            selectedAreas[i]['imageHeight'] = imageHeight;
                            jsons[i] = JSON.stringify(selectedAreas[i]);
                        }
                        jsons = JSON.stringify(jsons);
                        
                         $.ajax({
                            url: '/doExtract',
                            data: {"jsons":jsons, "fileName":"{{fileName}}", "page":this_page, "table_option":table_option, "line_scale":$("#line_scale").val()},
                            dataType:'json',
                            type: 'POST',
                            success: function (data) {
                                var html = data.html;
                                var bboxs = data.bboxs;
                                
                                $('#table_printer').html(html);
                                if(bboxs != 0){
                                    bboxs = bboxs.split(";");
                                    
                                    $("#pageImg").selectAreas('reset');
                                    
                                    arrs = [];
                                    for(i=0 ; i<bboxs.length ; i++){
                                        var arr = bboxs[i].split(',');
                                        
                                        arrs.push({
                                            x: Number(arr[0]),
                                            y: Number(arr[1]),
                                            width: Number(arr[2]),
                                            height: Number(arr[3]),
                                        });
                                    }
                                    
                                    $("#pageImg").selectAreas('add', arrs);
                                }
                            },
                            error: function (error) {
                              console.error(error);
                            }
                         });
                    }
				});


                $('#auto_detect').click(function(){
                    if( detected_areas.hasOwnProperty(String(page)) ){
                        $("#pageImg").selectAreas('reset');
                        page = String(this_page);
                        set_select_areas( detected_areas[page] );
                    }
                });


				$('img#pageImg').selectAreas({
                    width: window.innerWidth / 3.84
				});

                setTimeout(function(){
                    var imageWidth = $('#pageImg').width();
                    var imageHeight = $('#pageImg').height();

                    $('.image-decorator div, .image-decorator img').css({'height':'70vh', 'width':(imageWidth/imageHeight*100)*0.7+'vh'});
                    // $('.image-decorator div').css({'height':'70vh', 'width':(imageWidth/imageHeight*100)*0.7+'vh'});
                    
                    if( detected_areas.hasOwnProperty(String(this_page)) ){
                        page = String(this_page);
                        set_select_areas( detected_areas[page] );
                    }
                }, 500);


				$('#btnView').click(function () {
					var selectedAreas = $('img#pageImg').selectAreas('areas');
					displayAreas(selectedAreas);
				});
				$('#btnViewRel').click(function () {
					var areas = $('img#pageImg').selectAreas('relativeAreas');
					displayAreas(areas);
				});
				$('#btnReset').click(function () {
					output("reset")
					$('img#pageImg').selectAreas('reset');
				});
				$('#btnDestroy').click(function () {
					$('img#pageImg').selectAreas('destroy');

					output("destroyed")
					$('.actionOn').attr("disabled", "disabled");
					$('.actionOff').removeAttr("disabled")
				});
				$('#btnCreate').attr("disabled", "disabled").click(function () {
					$('img#pageImg').selectAreas({
						minSize: [10, 10],
						onChanged : debugQtyAreas,
						width: 500,
					});

					output("created")
					$('.actionOff').attr("disabled", "disabled");
					$('.actionOn').removeAttr("disabled")
				});
				$('#btnNew').click(function () {
					var areaOptions = {
						x: Math.floor((Math.random() * 200)),
						y: Math.floor((Math.random() * 200)),
						width: Math.floor((Math.random() * 100)) + 50,
						height: Math.floor((Math.random() * 100)) + 20,
					};
					output("Add a new area: " + areaToString(areaOptions))
					$('img#pageImg').selectAreas('add', areaOptions);
				});
				$('#btnNews').click(function () {
					var areaOption1 = {
						x: Math.floor((Math.random() * 200)),
						y: Math.floor((Math.random() * 200)),
						width: Math.floor((Math.random() * 100)) + 50,
						height: Math.floor((Math.random() * 100)) + 20,
					}, areaOption2 = {
						x: areaOption1.x + areaOption1.width + 10,
						y: areaOption1.y + areaOption1.height - 20,
						width: 50,
						height: 20,
					};
					output("Add a new area: " + areaToString(areaOption1) + " and " + areaToString(areaOption2))
					$('img#pageImg').selectAreas('add', [areaOption1, areaOption2]);
				});
			});

			var selectionExists;

			function areaToString (area) {
				return (typeof area.id === "undefined" ? "" : (area.id + ": ")) + area.x + ':' + area.y  + ' ' + area.width + 'x' + area.height + '<br />'
			}

			function output (text) {
				$('#output').html(text);
			}

			// Log the quantity of selections
			function debugQtyAreas (event, id, areas) {
				// console.log(areas.length + " areas", arguments);
			};

			// Display areas coordinates in a div
			function displayAreas (areas) {
				var text = "";
				$.each(areas, function (id, area) {
					text += areaToString(area);
				});
				output(text);
			};

		</script>
	</head>

	<body>
        <header>
            <ul>
                <li onclick='location.href="/"'>HOME</li>
                <li>BLAH BLAH</li>
                <li>BLAH BLAH</li>
                <!-- <li style='font-size: 24px;'><b>{{fileName}}.pdf</b>&nbsp;&nbsp;&nbsp; p{{page}}</li> -->
            </ul>
        </header>
        <div id='page_list_box'>
            {% for idx in empty_pages %}
                <div class='thumb_page'>
                    <center>
                        {% if idx == 1 %}
                        <img
                            class='thumb_img thumb_img_select'
                            src="{{url_for('static', filename='job_pdf')}}/{{fileName}}/page-{{idx}}-thumb.png"
                            onclick="
                                    move_page(this_page, '{{idx}}');
                                "
                            id="thumb_page_{{idx}}">

                        {% else %}
                        <img
                            class='thumb_img'
                            src="{{url_for('static', filename='job_pdf')}}/{{fileName}}/page-{{idx}}-thumb.png"
                            onclick="
                                    move_page(this_page, '{{idx}}');
                                "
                            id="thumb_page_{{idx}}">
                        {% endif %}
                        <br>
                        <span>{{idx}}</span>
                        <br><br>
                    </center>
                </div>
            {% endfor %}
        </div>

       <table id='article_table'>
           <tr>
                <td>
                    <div id="wrapper">

                        <input id='auto_detect' type='button' value='Auto Detected'>
                        <div style='float:right'>
                            <label title='Line Scale is the smallest length to detect PDF tables border lines'>
                                ‚Øë Line Scale&nbsp;<input style="width: 40px" type='text' id="line_scale" value="40">
                            </label>
                            
                            <label>
                                <input type='button' id="get_line_size" value="get Line Size">
                            </label>
                        </div>

                        <div class="image-decorator">
                            <img alt="Image principale" id="pageImg"/>
                        </div>
                        
                    <center>
                        <span class="arrow">‚óÄ</span>
                        <input type="text">
                        <span class="arrow">‚ñ∂</span>
                    </center>
                    </div>
                </td>
                
                <td>
                    <div style='position: absolute; top: 10%'>
                        <label class="radio-inline">
                            <input type="radio" name="optradio" value="areas">table_areas
                        </label>
                        <br>
                        <label class="radio-inline">
                            <input type="radio" name="optradio" value="regions" checked>table_regions
                        </label>
                    </div>

                    <input type="button" id="extract" value="ÌÖåÏù¥Î∏î Ï∂îÏ∂úüëâ" style="font-size: 18px; cursor:pointer;"/>
                </td>
                
                <td style="vertical-align: top">
                    <h1>Table Result</h1>
                    <div id='table_printer'></div>
                </td>
            </tr>
       </table>
	</body>
</html>
